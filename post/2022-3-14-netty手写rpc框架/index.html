<!doctype html><html><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Netty手写RPC框架</title>
<link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/styles.css></head><body class="d-flex flex-column justify-content-between min-vh-100"><nav class="navbar navbar-expand-lg bg-light"><div class=container-fluid><a class=navbar-brand href=/><img src=/assets/github.svg alt=Logo width=30 height=24 class="d-inline-block align-text-top">
Enaium的博客
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/contact/>联系</a></li><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/about/>关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-bs-toggle=dropdown href=# role=button aria-expanded=false><img alt=Logo width=30 height=24 src=/assets/language.svg></a><ul class=dropdown-menu></ul></li></ul></div></div></nav><div style=flex:1><div class=container><div class=card><div class=card-header>Netty手写RPC框架</div><div class=card-body><div class=card-text><p>协议就用上篇文章的协议</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Message</span> <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> order;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Message</span>(<span style=color:#66d9ef>long</span> order) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>order</span> <span style=color:#f92672>=</span> order;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getOrder</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> order;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>只不过<code>Message</code>加了个<code>Order</code>熟悉,</p><p>创建<code>Request</code>类,继承<code>Message</code>,<code>klass</code>是调用的<code>Class</code>目标,<code>name</code>,<code>parameterType</code>,<code>argument</code>分别是方法名称,参数类型,参数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Request</span> <span style=color:#66d9ef>extends</span> Message {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String klass;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;[]</span> parameterType;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> argument;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Request</span>(<span style=color:#66d9ef>long</span> order, String klass, String name, Class<span style=color:#f92672>&lt;?&gt;[]</span> parameterType, Object<span style=color:#f92672>[]</span> argument) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(order);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>klass</span> <span style=color:#f92672>=</span> klass;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>parameterType</span> <span style=color:#f92672>=</span> parameterType;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>argument</span> <span style=color:#f92672>=</span> argument;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getKlass</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> klass;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getName</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Class<span style=color:#f92672>&lt;?&gt;[]</span> getParameterType() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> parameterType;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getArgument</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> argument;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建<code>Response</code>类继承<code>Message</code>,<code>result</code>调用的结果,<code>throwable</code>调用的异常</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Response</span> <span style=color:#66d9ef>extends</span> Message {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Object result;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Throwable throwable;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Response</span>(<span style=color:#66d9ef>long</span> order, Object result, Throwable throwable) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(order);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> result;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>throwable</span> <span style=color:#f92672>=</span> throwable;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getResult</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Throwable <span style=color:#a6e22e>getThrowable</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> throwable;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建一个<code>PRCHandler</code>类,来处理请求,用反射调用即可</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PRCHandler</span> <span style=color:#66d9ef>extends</span> SimpleChannelInboundHandler<span style=color:#f92672>&lt;</span>Request<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelRead0</span>(ChannelHandlerContext channelHandlerContext, Request request) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Class<span style=color:#f92672>&lt;?&gt;</span> aClass <span style=color:#f92672>=</span> Class.<span style=color:#a6e22e>forName</span>(request.<span style=color:#a6e22e>getKlass</span>());
</span></span><span style=display:flex><span>            Object o <span style=color:#f92672>=</span> aClass.<span style=color:#a6e22e>getConstructor</span>().<span style=color:#a6e22e>newInstance</span>();
</span></span><span style=display:flex><span>            Object invoke <span style=color:#f92672>=</span> aClass.<span style=color:#a6e22e>getMethod</span>(request.<span style=color:#a6e22e>getName</span>(), request.<span style=color:#a6e22e>getParameterType</span>()).<span style=color:#a6e22e>invoke</span>(o, request.<span style=color:#a6e22e>getArgument</span>());
</span></span><span style=display:flex><span>            channelHandlerContext.<span style=color:#a6e22e>channel</span>().<span style=color:#a6e22e>writeAndFlush</span>(<span style=color:#66d9ef>new</span> Response(request.<span style=color:#a6e22e>getOrder</span>(), invoke, <span style=color:#66d9ef>null</span>));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (ClassNotFoundException <span style=color:#f92672>|</span> InvocationTargetException <span style=color:#f92672>|</span> InstantiationException <span style=color:#f92672>|</span> IllegalAccessException <span style=color:#f92672>|</span> NoSuchMethodException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            channelHandlerContext.<span style=color:#a6e22e>channel</span>().<span style=color:#a6e22e>writeAndFlush</span>(<span style=color:#66d9ef>new</span> Response(request.<span style=color:#a6e22e>getOrder</span>(), <span style=color:#66d9ef>null</span>, e.<span style=color:#a6e22e>getCause</span>()));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接着启动服务器,服务器就这样写好了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RPCServer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> LoggingHandler LOGGING_HANDLER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LoggingHandler(LogLevel.<span style=color:#a6e22e>INFO</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> MessageCodec MESSAGE_CODEC <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MessageCodec();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> PRCHandler PRC_HANDLER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PRCHandler();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        NioEventLoopGroup boss <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>        NioEventLoopGroup worker <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Channel localhost <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerBootstrap().<span style=color:#a6e22e>group</span>(boss, worker).<span style=color:#a6e22e>channel</span>(NioServerSocketChannel.<span style=color:#a6e22e>class</span>).<span style=color:#a6e22e>childHandler</span>(<span style=color:#66d9ef>new</span> ChannelInitializer<span style=color:#f92672>&lt;</span>SocketChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span>(SocketChannel channel) {
</span></span><span style=display:flex><span>                    channel.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(LOGGING_HANDLER);
</span></span><span style=display:flex><span>                    channel.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(MESSAGE_CODEC);
</span></span><span style=display:flex><span>                    channel.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(PRC_HANDLER);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }).<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#34;localhost&#34;</span>, 3828).<span style=color:#a6e22e>sync</span>().<span style=color:#a6e22e>channel</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Runnable...&#34;</span>);
</span></span><span style=display:flex><span>            localhost.<span style=color:#a6e22e>closeFuture</span>().<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            boss.<span style=color:#a6e22e>shutdownGracefully</span>();
</span></span><span style=display:flex><span>            worker.<span style=color:#a6e22e>shutdownGracefully</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在在<code>test</code>里测试一下,写好客户端连接,<code>Hanlder</code>先不用太关注</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> LoggingHandler LOGGING_HANDLER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LoggingHandler(LogLevel.<span style=color:#a6e22e>INFO</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> MessageCodec MESSAGE_CODEC <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MessageCodec();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Handler HANDLER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Channel channel;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        NioEventLoopGroup nioEventLoopGroup <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            channel <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Bootstrap().<span style=color:#a6e22e>group</span>(nioEventLoopGroup).<span style=color:#a6e22e>channel</span>(NioSocketChannel.<span style=color:#a6e22e>class</span>).<span style=color:#a6e22e>handler</span>(<span style=color:#66d9ef>new</span> ChannelInitializer<span style=color:#f92672>&lt;</span>SocketChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span>(SocketChannel channel) {
</span></span><span style=display:flex><span>                    channel.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(LOGGING_HANDLER);
</span></span><span style=display:flex><span>                    channel.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(MESSAGE_CODEC);
</span></span><span style=display:flex><span>                    channel.<span style=color:#a6e22e>pipeline</span>().<span style=color:#a6e22e>addLast</span>(HANDLER);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }).<span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;localhost&#34;</span>, 3828).<span style=color:#a6e22e>sync</span>().<span style=color:#a6e22e>channel</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>addShutdownHook</span>(<span style=color:#66d9ef>new</span> Thread(nioEventLoopGroup::shutdownGracefully));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建一个<code>Call</code>注解,<code>klass</code>是目标类,<code>name</code>是目标类的方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Call {
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>klass</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>name</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在创建一个目标类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Target</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>render</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;RENDER HELLO WORLD!&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建个一个<code>Service</code>接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Service</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Call</span>(klass <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cn.enaium.Target&#34;</span>, name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;render&#34;</span>)
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>render</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接着使用动态代理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;unchecked&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>getService</span>(Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> klass) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>没有<code>Call</code>注解的返回<code>null</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object o <span style=color:#f92672>=</span> Proxy.<span style=color:#a6e22e>newProxyInstance</span>(klass.<span style=color:#a6e22e>getClassLoader</span>(), <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span>{klass}, (proxy, method, args) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>method.<span style=color:#a6e22e>isAnnotationPresent</span>(Call.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用<code>Promise</code>来获取结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object o <span style=color:#f92672>=</span> Proxy.<span style=color:#a6e22e>newProxyInstance</span>(klass.<span style=color:#a6e22e>getClassLoader</span>(), <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span>{klass}, (proxy, method, args) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>method.<span style=color:#a6e22e>isAnnotationPresent</span>(Call.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Promise<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> promise <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultPromise<span style=color:#f92672>&lt;&gt;</span>(channel.<span style=color:#a6e22e>eventLoop</span>());
</span></span><span style=display:flex><span>    Call annotation <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getAnnotation</span>(Call.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> increment <span style=color:#f92672>=</span> Util.<span style=color:#a6e22e>increment</span>();
</span></span><span style=display:flex><span>    channel.<span style=color:#a6e22e>writeAndFlush</span>(<span style=color:#66d9ef>new</span> Request(increment, annotation.<span style=color:#a6e22e>klass</span>(), annotation.<span style=color:#a6e22e>name</span>(), method.<span style=color:#a6e22e>getParameterTypes</span>(), args));
</span></span><span style=display:flex><span>    Main.<span style=color:#a6e22e>HANDLER</span>.<span style=color:#a6e22e>getPromiseMap</span>().<span style=color:#a6e22e>put</span>(increment, promise);
</span></span><span style=display:flex><span>    promise.<span style=color:#a6e22e>await</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (promise.<span style=color:#a6e22e>cause</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RuntimeException(promise.<span style=color:#a6e22e>cause</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> promise.<span style=color:#a6e22e>getNow</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;unchecked&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>getService</span>(Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> klass) {
</span></span><span style=display:flex><span>    Object o <span style=color:#f92672>=</span> Proxy.<span style=color:#a6e22e>newProxyInstance</span>(klass.<span style=color:#a6e22e>getClassLoader</span>(), <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span>{klass}, (proxy, method, args) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>method.<span style=color:#a6e22e>isAnnotationPresent</span>(Call.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        Promise<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> promise <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultPromise<span style=color:#f92672>&lt;&gt;</span>(channel.<span style=color:#a6e22e>eventLoop</span>());
</span></span><span style=display:flex><span>        Call annotation <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getAnnotation</span>(Call.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> increment <span style=color:#f92672>=</span> Util.<span style=color:#a6e22e>increment</span>();
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>writeAndFlush</span>(<span style=color:#66d9ef>new</span> Request(increment, annotation.<span style=color:#a6e22e>klass</span>(), annotation.<span style=color:#a6e22e>name</span>(), method.<span style=color:#a6e22e>getParameterTypes</span>(), args));
</span></span><span style=display:flex><span>        Main.<span style=color:#a6e22e>HANDLER</span>.<span style=color:#a6e22e>getPromiseMap</span>().<span style=color:#a6e22e>put</span>(increment, promise);
</span></span><span style=display:flex><span>        promise.<span style=color:#a6e22e>await</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (promise.<span style=color:#a6e22e>cause</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RuntimeException(promise.<span style=color:#a6e22e>cause</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> promise.<span style=color:#a6e22e>getNow</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (T) o;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>序号自增</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Util</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> AtomicLong atomicLong <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicLong();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>increment</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> atomicLong.<span style=color:#a6e22e>incrementAndGet</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Handler</code>来处理响应,根据请求的<code>order</code>获取返回值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Handler</span> <span style=color:#66d9ef>extends</span> SimpleChannelInboundHandler<span style=color:#f92672>&lt;</span>Response<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Long, Promise<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;&gt;</span> promiseMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelRead0</span>(ChannelHandlerContext channelHandlerContext, Response response) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> promiseMap.<span style=color:#a6e22e>get</span>(response.<span style=color:#a6e22e>getOrder</span>())) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Promise<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> promise <span style=color:#f92672>=</span> promiseMap.<span style=color:#a6e22e>remove</span>(response.<span style=color:#a6e22e>getOrder</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (response.<span style=color:#a6e22e>getResult</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            promise.<span style=color:#a6e22e>setSuccess</span>(response.<span style=color:#a6e22e>getResult</span>());
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            promise.<span style=color:#a6e22e>setFailure</span>(response.<span style=color:#a6e22e>getThrowable</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>Long, Promise<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>getPromiseMap</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> promiseMap;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在来运行服务器和客户端测试一下</p><p><a href=https://github.com/Enaium-Learn/netty-rpc>源码</a></p><p><a href=https://www.bilibili.com/video/BV18Y411373o>视频</a></p></div><div class="d-flex justify-content-between"><a class=text-reset href=https://blog.enaium.cn/post/2022-3-12-netty%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/>Netty自定义协议</a>
<a class=text-reset href=https://blog.enaium.cn/post/2022-9-28%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8gatsby%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8D%9A%E5%AE%A2/>如何使用Gatsby创建自己的博客</a></div></div></div></div></div><footer class="p-5 bg-dark text-white text-center"><div class=container><p class=lead>Copyright &copy; 2024 Enaium</p></div></footer><script src=/js/bootstrap.bundle.min.js></script></body></html>