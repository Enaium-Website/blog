<!doctype html><html><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>120行代码手写一个简单的MyBatis实现简单的CRUD</title>
<link rel=stylesheet href=/css/bootstrap.min.css></head><body class="d-flex flex-column justify-content-between min-vh-100"><nav class="navbar navbar-expand-lg bg-light"><div class=container-fluid><a class=navbar-brand href=/><img src=https://simpleicons.org/icons/github.svg alt=Logo width=30 height=24 class="d-inline-block align-text-top">
Enaium's Blog
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/contact/>Contact</a></li><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/about/>About</a></li></ul></div></div></nav><div style=flex:1><div class=container><div class=card><div class=card-header>120行代码手写一个简单的MyBatis实现简单的CRUD</div><div class=card-body><div class=card-text><p>不用XML只用注解</p><p>首先需要创建6个注解</p><p>SQL用于输入SQL语句</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> SQL {
</span></span><span style=display:flex><span>    String<span style=color:#f92672>[]</span> <span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>用来表示这个方法是Update</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Update {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>用来表示这个方法是Select</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Select {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>用来表示这个方法是Insert</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Insert {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>用来表示这个方法是Delete</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Delete {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>用来表示方法参数名</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>PARAMETER</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Param {
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>好了注解写完了</p><p>开始写主类</p><p>用map实现简单的配置，然后读取配置连接数据库，然后程序关闭的时候关闭连接。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Satis</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Statement statement;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Satis</span>(Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> config) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        Class.<span style=color:#a6e22e>forName</span>(config.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;driver&#34;</span>));
</span></span><span style=display:flex><span>        Connection connection <span style=color:#f92672>=</span> DriverManager.<span style=color:#a6e22e>getConnection</span>(config.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;url&#34;</span>), config.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;username&#34;</span>), config.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;password&#34;</span>));
</span></span><span style=display:flex><span>        statement <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>createStatement</span>();
</span></span><span style=display:flex><span>        Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>addShutdownHook</span>(<span style=color:#66d9ef>new</span> Thread(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                statement.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>                connection.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (SQLException e) {
</span></span><span style=display:flex><span>                e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建<code>getMapper</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>getMapper</span>(Class<span style=color:#f92672>&lt;?&gt;</span> mapper) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用动态代理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>getMapper</span>(Class<span style=color:#f92672>&lt;?&gt;</span> mapper) {
</span></span><span style=display:flex><span>    Object instance <span style=color:#f92672>=</span> Proxy.<span style=color:#a6e22e>newProxyInstance</span>(mapper.<span style=color:#a6e22e>getClassLoader</span>(), <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span>{mapper}, <span style=color:#66d9ef>new</span> InvocationHandler() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (T) instance;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>遍历方法获取方法是否有<code>SQL</code>这个注解。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>isAnnotationPresent</span>(SQL.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建4个方法，分别获取方法是否有这几个注解。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isSelect</span>(Method method) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> method.<span style=color:#a6e22e>isAnnotationPresent</span>(Select.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isDelete</span>(Method method) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> method.<span style=color:#a6e22e>isAnnotationPresent</span>(Delete.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isInsert</span>(Method method) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> method.<span style=color:#a6e22e>isAnnotationPresent</span>(Insert.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isUpdate</span>(Method method) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> method.<span style=color:#a6e22e>isAnnotationPresent</span>(Update.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>遍历<code>SQL</code>注解的值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>isAnnotationPresent</span>(SQL.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>        SQL sql <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getAnnotation</span>(SQL.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (String value : sql.<span style=color:#a6e22e>value</span>()) {
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>获取方法上是否有<code>Select</code>或<code>Delete</code>注解，是的话把<code>SQL</code>参数的值(获取参数的<code>Param</code>注解的值)替换为调用方法时的参数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>isAnnotationPresent</span>(SQL.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>        SQL sql <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getAnnotation</span>(SQL.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (String value : sql.<span style=color:#a6e22e>value</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (isSelect(method) <span style=color:#f92672>||</span> isDelete(method)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (Parameter parameter : method.<span style=color:#a6e22e>getParameters</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (parameter.<span style=color:#a6e22e>isAnnotationPresent</span>(Param.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>                        Param param <span style=color:#f92672>=</span> parameter.<span style=color:#a6e22e>getAnnotation</span>(Param.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>                        value <span style=color:#f92672>=</span> value.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;#{&#34;</span> <span style=color:#f92672>+</span> param.<span style=color:#a6e22e>value</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;}&#34;</span>, args<span style=color:#f92672>[</span>index<span style=color:#f92672>]</span>.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    index<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果是<code>Insert</code>或<code>Update</code>注解，获取第一个参数，获取这个参数的所有方法并获取值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>isAnnotationPresent</span>(SQL.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>        SQL sql <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getAnnotation</span>(SQL.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (String value : sql.<span style=color:#a6e22e>value</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (isInsert(method) <span style=color:#f92672>||</span> isUpdate(method)) {
</span></span><span style=display:flex><span>                Class<span style=color:#f92672>&lt;?&gt;</span> parameterType <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getParameterTypes</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (Field declaredField : parameterType.<span style=color:#a6e22e>getDeclaredFields</span>()) {
</span></span><span style=display:flex><span>                    value <span style=color:#f92672>=</span> value.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;#{&#34;</span> <span style=color:#f92672>+</span> declaredField.<span style=color:#a6e22e>getName</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;}&#34;</span>, <span style=color:#e6db74>&#34;\&#34;&#34;</span> <span style=color:#f92672>+</span> parameterType.<span style=color:#a6e22e>getMethod</span>(getGetMethodName(declaredField.<span style=color:#a6e22e>getName</span>())).<span style=color:#a6e22e>invoke</span>(args<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>).<span style=color:#a6e22e>toString</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\&#34;&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>简单的获取方法名的方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getSetMethodName</span>(String name) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;set&#34;</span> <span style=color:#f92672>+</span> name.<span style=color:#a6e22e>substring</span>(0, 1).<span style=color:#a6e22e>toUpperCase</span>(Locale.<span style=color:#a6e22e>ROOT</span>) <span style=color:#f92672>+</span> name.<span style=color:#a6e22e>substring</span>(1);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getGetMethodName</span>(String name) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;get&#34;</span> <span style=color:#f92672>+</span> name.<span style=color:#a6e22e>substring</span>(0, 1).<span style=color:#a6e22e>toUpperCase</span>(Locale.<span style=color:#a6e22e>ROOT</span>) <span style=color:#f92672>+</span> name.<span style=color:#a6e22e>substring</span>(1);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>执行SQL语句，如果有返回值那就返回实例化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>isAnnotationPresent</span>(SQL.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>        SQL sql <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getAnnotation</span>(SQL.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (String value : sql.<span style=color:#a6e22e>value</span>()) {
</span></span><span style=display:flex><span>            String typeName <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getGenericReturnType</span>().<span style=color:#a6e22e>getTypeName</span>();
</span></span><span style=display:flex><span>            ResultSet resultSet <span style=color:#f92672>=</span> statement.<span style=color:#a6e22e>executeQuery</span>(value);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>typeName.<span style=color:#a6e22e>equals</span>(<span style=color:#e6db74>&#34;void&#34;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> toEntity(resultSet, typeName);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>将返回值实例化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>toEntity</span>(ResultSet resultSet, String className) <span style=color:#66d9ef>throws</span> SQLException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException, ClassNotFoundException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> list <span style=color:#f92672>=</span> className.<span style=color:#a6e22e>contains</span>(<span style=color:#e6db74>&#34;&lt;&#34;</span>);<span style=color:#75715e>//是不是列表</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (list) {
</span></span><span style=display:flex><span>        className <span style=color:#f92672>=</span> className.<span style=color:#a6e22e>substring</span>(className.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34;&lt;&#34;</span>) <span style=color:#f92672>+</span> 1, className.<span style=color:#a6e22e>lastIndexOf</span>(<span style=color:#e6db74>&#34;&gt;&#34;</span>));<span style=color:#75715e>//获取列表的泛型</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> klass <span style=color:#f92672>=</span> Class.<span style=color:#a6e22e>forName</span>(className);
</span></span><span style=display:flex><span>    HashMap<span style=color:#f92672>&lt;</span>String, Class<span style=color:#f92672>&lt;?&gt;&gt;</span> fieldNameList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> resultSet.<span style=color:#a6e22e>getMetaData</span>().<span style=color:#a6e22e>getColumnCount</span>(); i<span style=color:#f92672>++</span>) {<span style=color:#75715e>//获取字段和参数</span>
</span></span><span style=display:flex><span>        fieldNameList.<span style=color:#a6e22e>put</span>(resultSet.<span style=color:#a6e22e>getMetaData</span>().<span style=color:#a6e22e>getColumnName</span>(i <span style=color:#f92672>+</span> 1), Class.<span style=color:#a6e22e>forName</span>(resultSet.<span style=color:#a6e22e>getMetaData</span>().<span style=color:#a6e22e>getColumnClassName</span>(i <span style=color:#f92672>+</span> 1)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> objectList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (resultSet.<span style=color:#a6e22e>next</span>()) {
</span></span><span style=display:flex><span>        Object instance <span style=color:#f92672>=</span> klass.<span style=color:#a6e22e>newInstance</span>();<span style=color:#75715e>//实例化</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (Map.<span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String, Class<span style=color:#f92672>&lt;?&gt;&gt;</span> entry : fieldNameList.<span style=color:#a6e22e>entrySet</span>()) {<span style=color:#75715e>//遍历字段</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//调用set方法赋值</span>
</span></span><span style=display:flex><span>            klass.<span style=color:#a6e22e>getMethod</span>(getSetMethodName(entry.<span style=color:#a6e22e>getKey</span>()), entry.<span style=color:#a6e22e>getValue</span>()).<span style=color:#a6e22e>invoke</span>(instance, resultSet.<span style=color:#a6e22e>getObject</span>(entry.<span style=color:#a6e22e>getKey</span>(), entry.<span style=color:#a6e22e>getValue</span>()));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        objectList.<span style=color:#a6e22e>add</span>(instance);<span style=color:#75715e>//添加到列表</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    resultSet.<span style=color:#a6e22e>close</span>();<span style=color:#75715e>//关闭</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (objectList.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;<span style=color:#75715e>//如果列表为空返回null</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> list <span style=color:#f92672>?</span> (T) objectList : (T) objectList.<span style=color:#a6e22e>get</span>(0);<span style=color:#75715e>//判断是否为列表，如果是直接返回，如果不是取第一个</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>好了已经写完了。</p><p>现在来测试</p><p>实体</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AccountEntity</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer age;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AccountEntity</span>() {<span style=color:#75715e>//用了lombok就不会自动生成无参构造方法了</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccountMapper</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Select</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SQL</span>(<span style=color:#e6db74>&#34;select * from account&#34;</span>)
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>AccountEntity<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAll</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Select</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SQL</span>(<span style=color:#e6db74>&#34;select * from account where id = #{id}&#34;</span>)
</span></span><span style=display:flex><span>    AccountEntity <span style=color:#a6e22e>getById</span>(<span style=color:#a6e22e>@Param</span>(<span style=color:#e6db74>&#34;id&#34;</span>) Serializable id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Delete</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SQL</span>(<span style=color:#e6db74>&#34;delete from account where id = #{id}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteById</span>(<span style=color:#a6e22e>@Param</span>(<span style=color:#e6db74>&#34;id&#34;</span>) Serializable id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Insert</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SQL</span>(<span style=color:#e6db74>&#34;insert into account(id, name, age) values (#{id}, #{name}, #{age})&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span>(AccountEntity accountEntity);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Update</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SQL</span>(<span style=color:#e6db74>&#34;update account set name=#{name}, age=#{age} where id=#{id}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>update</span>(AccountEntity accountEntity);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>主类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        Satis satis <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Satis(ImmutableMap.<span style=color:#a6e22e>of</span>(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;url&#34;</span>, <span style=color:#e6db74>&#34;jdbc:mariadb://localhost:3306/enaium?useUnicode=true&amp;characterEncoding=UTF-8&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;driver&#34;</span>, <span style=color:#e6db74>&#34;org.mariadb.jdbc.Driver&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;username&#34;</span>, <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;password&#34;</span>, <span style=color:#e6db74>&#34;root&#34;</span>));<span style=color:#75715e>//使用guava</span>
</span></span><span style=display:flex><span>        AccountMapper mapper <span style=color:#f92672>=</span> satis.<span style=color:#a6e22e>getMapper</span>(AccountMapper.<span style=color:#a6e22e>class</span>);<span style=color:#75715e>//获取Mapper</span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(mapper.<span style=color:#a6e22e>getById</span>(1));<span style=color:#75715e>//获取ID为1的Account</span>
</span></span><span style=display:flex><span>        mapper.<span style=color:#a6e22e>getAll</span>().<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);<span style=color:#75715e>//获取所有Account</span>
</span></span><span style=display:flex><span>        mapper.<span style=color:#a6e22e>insert</span>(<span style=color:#66d9ef>new</span> AccountEntity(0L, <span style=color:#e6db74>&#34;Enaium&#34;</span>, 1));<span style=color:#75715e>//插入一个新的Account</span>
</span></span><span style=display:flex><span>        mapper.<span style=color:#a6e22e>getAll</span>().<span style=color:#a6e22e>forEach</span>((it) <span style=color:#f92672>-&gt;</span> {<span style=color:#75715e>//把所有Account的Age都改为0</span>
</span></span><span style=display:flex><span>            it.<span style=color:#a6e22e>setAge</span>(0);
</span></span><span style=display:flex><span>            mapper.<span style=color:#a6e22e>update</span>(it);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://github.com/Enaium-Learn/SimpleBatis/>源码</a></p></div><div class="d-flex justify-content-between"><a class=text-reset href=https://blog.enaium.cn/post/2021-4-15-%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D%E5%A6%82%E4%BD%95%E5%8F%91%E5%B8%83%E5%88%B0maven%E4%B8%AD%E5%A4%AE%E4%BB%93%E5%BA%93/>详细介绍如何发布到Maven中央仓库</a>
<a class=text-reset href=https://blog.enaium.cn/post/2021-4-27-asm%E6%95%99%E7%A8%8B>[ASM教程]#6树API</a></div></div></div></div></div><footer class="p-5 bg-dark text-white text-center"><div class=container><p class=lead>Copyright &copy; 2024 Enaium</p></div></footer><script src=/js/bootstrap.bundle.min.js></script></body></html>