<!doctype html><html><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>一个脚本让您的Gradle项目下载速度起飞</title>
<link rel=stylesheet href=/css/bootstrap.min.css></head><body class="d-flex flex-column justify-content-between min-vh-100"><nav class="navbar navbar-expand-lg bg-light"><div class=container-fluid><a class=navbar-brand href=/><img src=https://simpleicons.org/icons/github.svg alt=Logo width=30 height=24 class="d-inline-block align-text-top">
Enaium's Blog
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/contact/>Contact</a></li><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/about/>About</a></li></ul></div></div></nav><div style=flex:1><div class=container><div class=card><div class=card-header>一个脚本让您的Gradle项目下载速度起飞</div><div class=card-body><div class=card-text><h2 id=前言>前言</h2><p><code>Gradle</code>是一个非常优秀的构建工具，但用过<code>Maven</code>的人都知道，<code>Maven</code>可以设置镜像，加速下载速度，而<code>Gradle</code>却没有这个功能。因为<code>Gradle</code>没有<code>Maven</code>这么死板的概念，在<code>Gradle</code>中大部分功能都是通过脚本实现的，所以我们可以通过脚本来实现镜像的功能。</p><p>首先需要了解一下什么是<code>Initialization scripts</code>，<code>Initialization scripts</code>是<code>Gradle</code>的初始化脚本，它可以在<code>Gradle</code>启动时执行，<code>Gradle</code>会在执行构建之前执行初始化脚本，也就是说我们可以在这个时候编写替换仓库地址的脚本，这样就可以实现镜像的功能。</p><h2 id=脚本>脚本</h2><p>首先我们需要再用户目录下的<code>.gradle</code>的目录下创建一个<code>init.gradle.kts</code>文件，然后在这个文件中编写脚本。</p><p>首先使用<code>apply</code>给脚本添加一个<code>EnterpriseRepositoryPlugin</code>插件，之后编写一个类实现<code>Plugin</code>接口，然后我们在<code>apply</code>方法中编写替换仓库地址的逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>apply&lt;EnterpriseRepositoryPlugin&gt;()
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnterpriseRepositoryPlugin</span> : Plugin&lt;Gradle&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>apply</span>(gradle: Gradle) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>首先我们创建一个派生类，在这个派生类中定义一些常量，这些常量是我们要替换的仓库地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>companion</span> <span style=color:#66d9ef>object</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> CENTRAL = <span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/central&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> GRADLE_PLUGIN = <span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/gradle-plugin&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>之后在这里使用<code>gradle.settingsEvaluated</code>方法，这个方法会在<code>settings.gradle</code>文件被解析之后执行，我们可以在这个方法中编写替换插件仓库地址的逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>gradle.settingsEvaluated {
</span></span><span style=display:flex><span>    pluginManagement {
</span></span><span style=display:flex><span>        repositories {
</span></span><span style=display:flex><span>            all {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> MavenArtifactRepository) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>val</span> url = <span style=color:#66d9ef>this</span>.url.toString()
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://repo1.maven.org/maven2&#34;</span>) <span style=color:#f92672>||</span> url.startsWith(<span style=color:#e6db74>&#34;https://repo.maven.apache.org/maven2&#34;</span>)) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span>.setUrl(CENTRAL)
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://plugins.gradle.org/m2&#34;</span>)) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span>.setUrl(GRADLE_PLUGIN)
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在完成插件的仓库地址替换之后，我们还需要替换项目的仓库地址，逻辑和替换插件的仓库地址一样。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>gradle.allprojects {
</span></span><span style=display:flex><span>    repositories {
</span></span><span style=display:flex><span>        all {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> MavenArtifactRepository) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>val</span> url = <span style=color:#66d9ef>this</span>.url.toString()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://repo1.maven.org/maven2&#34;</span>) <span style=color:#f92672>||</span> url.startsWith(<span style=color:#e6db74>&#34;https://repo.maven.apache.org/maven2&#34;</span>)) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.setUrl(CENTRAL)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://plugins.gradle.org/m2&#34;</span>)) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.setUrl(GRADLE_PLUGIN)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样完成之后，我们就可以飞快的下载项目中的插件和依赖了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>apply&lt;EnterpriseRepositoryPlugin&gt;()
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnterpriseRepositoryPlugin</span> : Plugin&lt;Gradle&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>companion</span> <span style=color:#66d9ef>object</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> CENTRAL = <span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/central&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> GRADLE_PLUGIN = <span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/gradle-plugin&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>apply</span>(gradle: Gradle) {
</span></span><span style=display:flex><span>        gradle.settingsEvaluated {
</span></span><span style=display:flex><span>            pluginManagement {
</span></span><span style=display:flex><span>                repositories {
</span></span><span style=display:flex><span>                    all {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> MavenArtifactRepository) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>val</span> url = <span style=color:#66d9ef>this</span>.url.toString()
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://repo1.maven.org/maven2&#34;</span>) <span style=color:#f92672>||</span> url.startsWith(<span style=color:#e6db74>&#34;https://repo.maven.apache.org/maven2&#34;</span>)) {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>this</span>.setUrl(CENTRAL)
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://plugins.gradle.org/m2&#34;</span>)) {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>this</span>.setUrl(GRADLE_PLUGIN)
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        gradle.allprojects {
</span></span><span style=display:flex><span>            repositories {
</span></span><span style=display:flex><span>                all {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> MavenArtifactRepository) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>val</span> url = <span style=color:#66d9ef>this</span>.url.toString()
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://repo1.maven.org/maven2&#34;</span>) <span style=color:#f92672>||</span> url.startsWith(<span style=color:#e6db74>&#34;https://repo.maven.apache.org/maven2&#34;</span>)) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span>.setUrl(CENTRAL)
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (url.startsWith(<span style=color:#e6db74>&#34;https://plugins.gradle.org/m2&#34;</span>)) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span>.setUrl(GRADLE_PLUGIN)
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class="d-flex justify-content-between"><a class=text-reset href=https://blog.enaium.cn/post/2024-1-23-fabric%E6%A8%A1%E7%BB%84%E5%BC%80%E5%8F%91%E4%B8%AD4%E4%B8%AA%E7%83%AD%E9%87%8D%E8%BD%BD%E7%9A%84%E6%96%B9%E6%B3%95/>Fabric模组开发中4个热重载的方法</a>
<a class=text-reset href=https://blog.enaium.cn/post/2024-3-4-jdk22%E6%96%B0%E7%89%B9%E6%80%A7class-file-api%E5%B0%9D%E9%B2%9C/>JDK22新特性Class-File API尝鲜</a></div></div></div></div></div><footer class="p-5 bg-dark text-white text-center"><div class=container><p class=lead>Copyright &copy; 2024 Enaium</p></div></footer><script src=/js/bootstrap.bundle.min.js></script></body></html>